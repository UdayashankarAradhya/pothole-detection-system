<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru Pothole Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header Styling */
        header { 
            background-color: #ff4757; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000; position: relative;
        }
        
        /* Map Styling */
        #map { height: 92vh; width: 100%; }
        
        /* Status Box */
        .status-box {
            position: absolute; bottom: 20px; left: 20px;
            background: white; padding: 15px; border-radius: 8px;
            z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <header>
        <button onclick="clearMap()" style="
        position: absolute; 
        top: 80px; 
        right: 20px; 
        z-index: 2000; 
        padding: 10px 20px; 
        background: white; 
        color: red; 
        border: 2px solid red; 
        font-weight: bold; 
        cursor: pointer; 
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    ">
        üóëÔ∏è RESET MAP
    </button>
        <h1>üöß Live Pothole Detection System</h1>
    </header>

    <div id="map"></div>

    <div class="status-box">
        <strong>System Status:</strong> <span id="status" style="color:green">Live</span><br>
        <strong>Total Potholes:</strong> <span id="count">0</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Initialize Map (Centered on Bengaluru)
        const map = L.map('map').setView([12.9716, 77.5946], 12);

        // 2. Add OpenStreetMap Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Store markers to avoid duplicates
        let markers = [];

        // 3. Function to Fetch Data
        // --- Define Custom Danger Icon ---
        const dangerIcon = L.divIcon({
            className: 'custom-danger-icon',
            html: `
                <div style="
                    background-color: #ff0000; 
                    width: 35px; 
                    height: 35px; 
                    border-radius: 50%; 
                    border: 3px solid white; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    box-shadow: 0 3px 10px rgba(0,0,0,0.6); 
                    font-size: 20px;
                    animation: pulse 2s infinite;
                ">
                    üíÄ
                </div>`,
            iconSize: [35, 35],
            iconAnchor: [17, 17], // Center the icon
            popupAnchor: [0, -20] // Popup appears above it
        });

        // --- Add CSS Animation for "Pulsing" Effect ---
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
                100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
            }
        `;
        document.head.appendChild(styleSheet);


        // --- 3. Function to Fetch Data ---
        async function fetchPotholes() {
            try {
                const response = await fetch('/api/getpotholes');
                const potholes = await response.json();

                // Update count
                document.getElementById('count').innerText = potholes.length;

                // Clear old markers
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                // Add new markers
                potholes.forEach(p => {
                    // Create custom popup content
                    const popupContent = `
                        <div style="text-align:center">
                            <h3 style="color:red; margin:0;">üíÄ DANGER!</h3>
                            <b>Severe Pothole Detected</b><br>
                            <hr style="margin:5px 0;">
                            <b>Impact:</b> ${p.z_accel} G<br>
                            <b>Depth:</b> ${p.distance_cm} cm<br>
                            <small style="color:gray">${new Date(p.timestamp).toLocaleTimeString()}</small>
                        </div>
                    `;

                    // *** USE THE CUSTOM ICON HERE ***
                    const marker = L.marker([p.lat, p.lng], { icon: dangerIcon })
                        .addTo(map)
                        .bindPopup(popupContent);
                    
                    markers.push(marker);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('status').innerText = "Offline";
                document.getElementById('status').style.color = "red";
            }
        }

        // 4. Auto-Refresh every 2 seconds
        fetchPotholes();
        setInterval(fetchPotholes, 2000);
        // --- Function to Clear Database ---
        async function clearMap() {
            // 1. Ask for confirmation so you don't click it by accident
            if (confirm("‚ö†Ô∏è Are you sure you want to delete ALL pothole data? This cannot be undone.")) {
                try {
                    // 2. Send the delete signal to your Node.js server
                    const response = await fetch('/api/clear', { method: 'DELETE' });
                    
                    if (response.ok) {
                        alert("Map Cleared!");
                        location.reload(); // Refresh page to show empty map
                    } else {
                        alert("Failed to clear map.");
                    }
                } catch (error) {
                    console.error('Error clearing map:', error);
                    alert("Server Error");
                }
            }
        }

    </script>
</body>
</html>