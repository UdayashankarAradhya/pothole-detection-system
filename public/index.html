<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bengaluru Pothole Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header Styling */
        header { 
            background-color: #ff4757; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000; position: relative;
        }
        
        /* Map Styling */
        #map { height: 92vh; width: 100%; }
        
        /* Status Box */
        .status-box {
            position: absolute; bottom: 20px; left: 20px;
            background: white; padding: 15px; border-radius: 8px;
            z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <header>
        <h1>üöß Live Pothole Detection System</h1>
    </header>

    <div id="map"></div>

    <div class="status-box">
        <strong>System Status:</strong> <span id="status" style="color:green">Live</span><br>
        <strong>Total Potholes:</strong> <span id="count">0</span>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Initialize Map (Centered on Bengaluru)
        const map = L.map('map').setView([12.9716, 77.5946], 12);

        // 2. Add OpenStreetMap Tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Store markers to avoid duplicates
        let markers = [];

        // 3. Function to Fetch Data
        async function fetchPotholes() {
            try {
                const response = await fetch('/api/getpotholes');
                const potholes = await response.json();

                // Update count
                document.getElementById('count').innerText = potholes.length;

                // Clear old markers
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                // Add new markers
                potholes.forEach(p => {
                    // Create custom popup content
                    const popupContent = `
                        <b>‚ö†Ô∏è POTHOLE DETECTED</b><br>
                        <b>Impact:</b> ${p.z_accel} G<br>
                        <b>Depth:</b> ${p.distance_cm} cm<br>
                        <small>${new Date(p.timestamp).toLocaleTimeString()}</small>
                    `;

                    const marker = L.marker([p.lat, p.lng])
                        .addTo(map)
                        .bindPopup(popupContent);
                    
                    markers.push(marker);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('status').innerText = "Offline";
                document.getElementById('status').style.color = "red";
            }
        }

        // 4. Auto-Refresh every 2 seconds
        fetchPotholes();
        setInterval(fetchPotholes, 2000);

    </script>
</body>
</html>